// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  ADMIN
  FINANCIAL
  SUPPORT
  AUDITOR
  INSTRUCTOR
  STUDENT
}

enum LessonStatus {
  PENDING
  SCHEDULED
  ACTIVE
  FINISHED
  CANCELLED
  EXPIRED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  PIX
  DINHEIRO
  DEBITO
  CREDITO
  CREDIT_CARD
  BOLETO
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
  CLOSED
}

enum InstructorStatus {
  PENDING_VERIFICATION
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum VehicleCategory {
  HATCH
  SEDAN
  SUV
  PICKUP
  SPORTIVO
  COMPACTO
  ELETRICO
  MOTO
}

enum TransmissionType {
  MANUAL
  AUTOMATICO
  CVT
  SEMI_AUTOMATICO
}

enum FuelType {
  GASOLINA
  ETANOL
  FLEX
  DIESEL
  ELETRICO
  HIBRIDO
}

enum ComplaintType {
  INAPPROPRIATE_BEHAVIOR
  INADEQUATE_VEHICLE
  HARASSMENT
  DANGEROUS_DRIVING
  OTHER
}

enum ComplaintStatus {
  PENDING
  UNDER_REVIEW
  RESOLVED
  DISMISSED
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
  PENDING_MORE_DOCS
}

enum NotificationType {
  DOCUMENT_APPROVED
  DOCUMENT_REJECTED
  DOCUMENT_MORE_DOCS_REQUESTED
  LESSON_SCHEDULED
  LESSON_CANCELLED
  PAYMENT_RECEIVED
  SYSTEM_ALERT
}

// ==================== MODELS ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  emailVerified DateTime?
  image         String?
  phone         String?
  password      String?
  role          UserRole  @default(STUDENT)
  pushToken     String?
  // notificationPreferences Json? @default("{\"email\":true,\"push\":true,\"sms\":false}")
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  student       Student?
  instructor    Instructor?
  activityLogs  ActivityLog[]
  vehicles      Vehicle[]
  notifications Notification[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Student {
  id           String   @id @default(cuid())
  userId       String   @unique
  cpf          String?  @unique
  dateOfBirth  DateTime?
  address      String?
  city         String?
  state        String?
  zipCode      String?
  points       Int      @default(0)
  level        Int      @default(1)
  badges       String[]
  walletBalance Decimal @default(0) @db.Decimal(10, 2)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessons           Lesson[]
  payments          Payment[]
  ratings           Rating[]
  referrals         Referral[]       @relation("Referrer")
  referredBy        Referral?        @relation("Referred")
  bundlePurchases   BundlePurchase[]
  skillEvaluations  SkillEvaluation[]
  walletTransactions WalletTransaction[]
  complaintsMade     Complaint[]

  @@index([userId])
  @@index([cpf])
  @@map("students")
}

model Instructor {
  id                String           @id @default(cuid())
  userId            String           @unique
  cpf               String?          @unique
  cnhNumber         String?          @unique
  credentialNumber  String?
  credentialExpiry  DateTime?
  cnhDocument       String?
  credentialDoc     String?
  cep               String?
  street            String?
  neighborhood      String?
  latitude          Float?
  longitude         Float?
  city              String?
  state             String?
  basePrice         Decimal          @default(0) @db.Decimal(10, 2)
  isAvailable       Boolean          @default(false)
  isOnline          Boolean          @default(false)
  acceptsOwnVehicle Boolean          @default(false)
  bio               String?
  status            InstructorStatus @default(PENDING_VERIFICATION)
  averageRating     Float            @default(0)
  totalLessons      Int              @default(0)
  stripeAccountId      String?       @unique
  stripeOnboarded      Boolean       @default(false)
  stripeChargesEnabled Boolean       @default(false)
  stripePayoutsEnabled Boolean       @default(false)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessons           Lesson[]
  availability      InstructorAvailability[]
  plans             Plan[]
  ratings           Rating[]
  skillEvaluations  SkillEvaluation[]
  complaintsReceived Complaint[]
  documents         InstructorDocument?

  @@index([userId])
  @@index([status])
  @@index([isAvailable])
  @@map("instructors")
}

model InstructorAvailability {
  id           String   @id @default(cuid())
  instructorId String
  dayOfWeek    Int
  startTime    String
  endTime      String
  
  instructor   Instructor @relation(fields: [instructorId], references: [id], onDelete: Cascade)

  @@index([instructorId])
  @@map("instructor_availability")
}

model InstructorDocument {
  id                  String         @id @default(cuid())
  instructorId        String         @unique
  cnhFrontUrl         String?
  cnhBackUrl          String?
  certificateUrl      String?
  status              DocumentStatus @default(PENDING)
  analysisNote        String?        @db.Text
  confirmedAutonomous Boolean        @default(false)
  submittedAt         DateTime?
  reviewedAt          DateTime?
  reviewedBy          String?
  
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  
  instructor          Instructor     @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  
  @@index([status])
  @@index([instructorId])
  @@map("instructor_documents")
}

model Lesson {
  id               String       @id @default(cuid())
  studentId        String
  instructorId     String
  scheduledAt      DateTime
  startedAt        DateTime?
  endedAt          DateTime?
  duration         Int?
  lessonType       String?
  vehicleId        String?
  useOwnVehicle    Boolean      @default(false)
  planId           String?
  paymentMethod    PaymentMethod @default(PIX)
  installments     Int          @default(1)
  pickupLatitude   Float?
  pickupLongitude  Float?
  pickupAddress    String?
  currentLatitude  Float?
  currentLongitude Float?
  status           LessonStatus @default(PENDING)
  price            Decimal      @db.Decimal(10, 2)
  usedBundleCredit Boolean      @default(false)
  bundlePurchaseId String?
  recordingUrl     String?
  recordingConsent Boolean      @default(false)
  receiptUrl       String?
  pixCode          String?
  pixQrCode        String?
  pixGeneratedAt   DateTime?
  pixExpiresAt     DateTime?
  pixPaidAt        DateTime?
  paymentStatus    PaymentStatus @default(PENDING)
  instructorNotes  String?
  studentNotes     String?
  
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  student          Student            @relation(fields: [studentId], references: [id], onDelete: Cascade)
  instructor       Instructor         @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  payment          Payment?
  rating           Rating?
  chatMessages     ChatMessage[]
  skillEvaluations SkillEvaluation[]

  @@index([studentId])
  @@index([instructorId])
  @@index([status])
  @@index([scheduledAt])
  @@map("lessons")
}

model Payment {
  id              String        @id @default(cuid())
  lessonId        String        @unique
  studentId       String
  amount          Decimal       @db.Decimal(10, 2)
  method          PaymentMethod
  status          PaymentStatus @default(PENDING)
  stripePaymentId String?       @unique
  stripeCustomerId String?
  pixQrCode       String?
  pixCopyPaste    String?
  metadata        Json?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  lesson          Lesson        @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  student         Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  dispute         Dispute?
  split           PaymentSplit?

  @@index([studentId])
  @@index([status])
  @@index([stripePaymentId])
  @@map("payments")
}

model Dispute {
  id          String        @id @default(cuid())
  paymentId   String        @unique
  reason      String
  description String?
  status      DisputeStatus @default(OPEN)
  resolution  String?
  resolvedAt  DateTime?
  resolvedBy  String?
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  payment     Payment       @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([status])
  @@map("disputes")
}

model Rating {
  id           String   @id @default(cuid())
  lessonId     String   @unique
  studentId    String
  instructorId String
  rating       Int
  comment      String?
  
  createdAt    DateTime @default(now())

  lesson       Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  student      Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  instructor   Instructor @relation(fields: [instructorId], references: [id], onDelete: Cascade)

  @@index([instructorId])
  @@index([rating])
  @@map("ratings")
}

model Referral {
  id         String   @id @default(cuid())
  referrerId String
  referredId String?   @unique
  code       String   @unique
  rewardAmount Decimal @default(0) @db.Decimal(10, 2)
  rewardPaid   Boolean @default(false)
  
  createdAt  DateTime @default(now())

  referrer   Student  @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referred   Student?  @relation("Referred", fields: [referredId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@map("referrals")
}

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  resource  String?
  metadata  Json?
  
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("activity_logs")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String           @db.Text
  data      Json?
  read      Boolean          @default(false)
  readAt    DateTime?
  
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

model Plan {
  id          String   @id @default(cuid())
  name        String
  description String?
  lessons     Int
  price       Decimal  @db.Decimal(10, 2)
  discount    Int      @default(0)
  isActive    Boolean  @default(true)
  featured    Boolean  @default(false)
  instructorId String?
  instructor   Instructor? @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive, featured])
  @@index([instructorId])
  @@map("plans")
}

model Bundle {
  id          String   @id @default(cuid())
  name        String
  description String?
  totalLessons Int
  price        Decimal  @db.Decimal(10, 2)
  discount     Decimal  @default(0) @db.Decimal(5, 2)
  expiryDays   Int?
  isActive     Boolean  @default(true)
  featured     Boolean  @default(false)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  purchases    BundlePurchase[]

  @@index([isActive, featured])
  @@map("bundles")
}

model BundlePurchase {
  id              String        @id @default(cuid())
  studentId       String
  bundleId        String
  totalCredits    Int
  usedCredits     Int           @default(0)
  remainingCredits Int
  amount          Decimal       @db.Decimal(10, 2)
  paymentId       String?       @unique
  paymentStatus   PaymentStatus @default(PENDING)
  expiresAt       DateTime?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  student         Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  bundle          Bundle        @relation(fields: [bundleId], references: [id])
  payment         BundlePayment?

  @@index([studentId, paymentStatus])
  @@index([expiresAt])
  @@map("bundle_purchases")
}

model BundlePayment {
  id                 String             @id @default(cuid())
  bundlePurchaseId   String             @unique
  amount             Decimal            @db.Decimal(10, 2)
  method             PaymentMethod
  status             PaymentStatus      @default(PENDING)
  stripePaymentId    String?            @unique
  stripeCustomerId   String?
  pixQrCode          String?
  pixCopyPaste       String?
  metadata           Json?
  
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  bundlePurchase     BundlePurchase     @relation(fields: [bundlePurchaseId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([stripePaymentId])
  @@map("bundle_payments")
}

model ChatMessage {
  id         String   @id @default(cuid())
  lessonId   String
  senderId   String
  content    String   @db.Text
  messageType String  @default("text")
  mediaUrl    String?
  mediaDuration Int?
  isRead     Boolean  @default(false)
  readAt     DateTime?
  
  createdAt  DateTime @default(now())

  lesson     Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId, createdAt])
  @@index([senderId])
  @@map("chat_messages")
}

model Skill {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String
  weight      Int      @default(1)
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  evaluations SkillEvaluation[]

  @@index([category, order])
  @@map("skills")
}

model SkillEvaluation {
  id           String   @id @default(cuid())
  lessonId     String
  studentId    String
  skillId      String
  instructorId String
  rating       Int
  comment      String?
  
  createdAt    DateTime @default(now())

  lesson       Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  student      Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  skill        Skill      @relation(fields: [skillId], references: [id])
  instructor   Instructor @relation(fields: [instructorId], references: [id])

  @@unique([lessonId, skillId])
  @@index([studentId, skillId])
  @@index([instructorId])
  @@map("skill_evaluations")
}

model PaymentSplit {
  id                String   @id @default(cuid())
  paymentId         String   @unique
  totalAmount       Decimal  @db.Decimal(10, 2)
  platformFee       Decimal  @db.Decimal(10, 2)
  instructorAmount  Decimal  @db.Decimal(10, 2)
  transferId        String?  @unique
  transferStatus    String?
  transferredAt     DateTime?
  createdAt         DateTime @default(now())

  payment           Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([transferStatus])
  @@map("payment_splits")
}

model CancellationPolicy {
  id                String   @id @default(cuid())
  lessonId          String   @unique
  cancelledBy       String
  cancelledAt       DateTime
  scheduledTime     DateTime
  hoursBeforeLesson Int
  penaltyApplied    Boolean  @default(false)
  penaltyAmount     Decimal  @default(0) @db.Decimal(10, 2)
  penaltyPaidTo     String?
  reason            String?
  
  createdAt         DateTime @default(now())

  @@index([cancelledBy])
  @@index([cancelledAt])
  @@map("cancellation_policies")
}

model Vehicle {
  id               String            @id @default(cuid())
  userId           String
  brand            String
  model            String
  year             Int
  color            String
  plateLastFour    String
  photoUrl         String?
  photos           String[]          @default([])
  category         VehicleCategory
  transmission     TransmissionType
  fuel             FuelType
  engine           String
  horsePower       Int?
  hasDualPedal     Boolean           @default(false)
  pedalPhotoUrl    String?
  acceptStudentCar Boolean           @default(false)
  safetyFeatures   String[]
  comfortFeatures  String[]
  status           String            @default("active")
  
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([status])
  @@map("vehicles")
}

model WalletTransaction {
  id          String   @id @default(cuid())
  studentId   String
  amount      Decimal  @db.Decimal(10, 2)
  type        String
  description String?
  metadata    Json?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@map("wallet_transactions")
}

model Complaint {
  id          String   @id @default(cuid())
  studentId   String
  instructorId String
  type        ComplaintType
  description String   @db.Text
  mediaUrls   String[]
  status      ComplaintStatus @default(PENDING)
  resolution  String?  @db.Text
  resolvedAt  DateTime?
  resolvedBy  String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  student     Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  instructor  Instructor @relation(fields: [instructorId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([instructorId])
  @@index([status])
  @@map("complaints")
}
